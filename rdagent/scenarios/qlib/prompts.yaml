hypothesis_and_feedback: |-
  =========================================================
  {% for experiment, feedback in trace.hist %}
  # 试验 {{ loop.index }}：
  ## 假设
  {{ experiment.hypothesis }}
  ## 具体任务：
  {% for task in experiment.sub_tasks %}
  {% if task is not none and task.get_task_brief_information is defined %}
  {{ task.get_task_brief_information() }}
  {% endif %}
  {% endfor %}
  ## 回测分析与反馈：
  {% if experiment.result is not none %}
  回测结果：{{ experiment.result.loc["IC", "1day.excess_return_without_cost.annualized_return", "1day.excess_return_without_cost.max_drawdown"] }}
  {% endif %}
  观察：{{ feedback.observations }}
  假设评估：{{ feedback.hypothesis_evaluation }}
  决策（假设是否成功）：{{ feedback.decision }}
  =========================================================
  {% endfor %}

last_hypothesis_and_feedback: |-
  ## 假设
  {{ experiment.hypothesis }}
  ## 具体任务：
  {% for task in experiment.sub_tasks %}
  {% if task is not none and task.get_task_brief_information is defined %}
  {{ task.get_task_brief_information() }}
  {% endif %}
  {% endfor %}
  ## 回测分析与反馈：
  {% if experiment.result is not none %}
  回测结果：{{ experiment.result.loc["IC", "1day.excess_return_without_cost.annualized_return", "1day.excess_return_without_cost.max_drawdown"] }}
  {% endif %}
  训练日志：
  在此，您需要重点分析训练是否存在问题。如果发现任何问题，必须在下一次迭代中进行修正，并清楚地描述如何在假设中进行更改。
  {{ experiment.stdout }}
  观察：{{ feedback.observations }}
  评估：{{ feedback.hypothesis_evaluation }}
  决策（此实验是否为SOTA）：{{ feedback.decision }}
  新假设（在反馈阶段给出，仅供参考，可以在下一轮接受或拒绝）：{{ feedback.new_hypothesis }}
  理由（新假设的依据）：{{ feedback.reason }}

sota_hypothesis_and_feedback: |-
  ## 假设
  {{ experiment.hypothesis }}
  ## 具体任务：
  {% for task in experiment.sub_tasks %}
  {% if task is not none and task.get_task_brief_information is defined %}
  {{ task.get_task_brief_information() }}
  {% endif %}
  {% endfor %}
  ## 回测分析与反馈：
  {% if experiment.result is not none %}
  回测结果：{{ experiment.result.loc["IC", "1day.excess_return_without_cost.annualized_return", "1day.excess_return_without_cost.max_drawdown"] }}
  {% endif %}
  训练日志：{{ experiment.stdout }}
  观察：{{ feedback.observations }}
  评估：{{ feedback.hypothesis_evaluation }}
  决策（此实验是否为SOTA）：{{ feedback.decision }}

hypothesis_output_format: |-
  输出应遵循JSON格式。模式如下：
  {
  "hypothesis": "一个确切的、可测试的、创新的陈述，源于先前实验轨迹分析。避免过于笼统的想法，确保精确。假设应清楚地指定确切的方法和预期的性能改进，通常用两到三句话表述。",
  "reason": "提供一个清晰、合乎逻辑的解释，说明为什么提出这个假设，基于证据（例如，轨迹历史、领域原则）。理由应简短，通常不超过两句话。",
  }

factor_hypothesis_output_format: |-
  输出应遵循JSON格式。模式如下：
  {
  "hypothesis": "根据提供的信息生成的新假设。通常用两到三句话表述。",
  "reason": "生成此假设的原因。应全面且合乎逻辑。应涵盖下面的其他关键点并扩展它们。通常用两到三句话表述。",
  }

hypothesis_output_format_with_action: |-
  输出应遵循JSON格式。模式如下：
  {
  "action": "如果`hypothesis_specification`提供了您需要采取的行动，请遵循`hypothesis_specification`选择行动。否则，根据先前的实验结果，建议您认为目前最合适的行动。应为[`factor`, `model`]之一。",
  "hypothesis": "根据提供的信息生成的新假设。",
  "reason": "生成此假设的原因。应全面且合乎逻辑。应涵盖下面的其他关键点并扩展它们。通常用两到三句话表述。",
  }

model_hypothesis_specification: |-
  1. 首先，观察和分析`hypothesis_and_feedback`中的整体实验进展。分析之前的模型设计不足之处——是由于参数设置、架构缺陷，还是缺乏新意（提出全新概念是高度鼓励的，只要它们证明有效）。
  2. 其次，`last_hypothesis_and_feedback`和`sota_hypothesis_and_feedback`是您应该密切关注的关键参考。您可以选择基于它们中的任何一个进行优化，或者生成新想法以形成假设和实验。
  3. 如果一开始没有可用的先前实验或结果，您可以先实现一个简单小型的架构。
  4. 如果一系列尝试未能达到SOTA，考虑探索全新的方向；此时，可以接受返回简单架构。
  5. 专注于PyTorch模型的架构。每个假设应特别针对架构决策，例如层配置、激活函数、正则化方法和整体模型结构。不要进行任何特征特定的处理。相反，您可以对输入的时间序列数据提出创新的转换，以增强模型训练的有效性。
  6. 避免包括与架构无关的方面，例如输入特征或优化策略。
  7. 有时，当训练性能较差时，调整超参数也可能是有效的改进策略。
  8. 对于基线模型使用标准库，但也要探索自定义架构设计，以研究新颖结构。在对传统模型进行足够的试验后，力求在时间序列建模方面实现可与顶级AI会议（NeurIPS、ICLR、ICML、SIGKDD等）相媲美的创新。

factor_hypothesis_specification: |-
  1. **每次生成1-5个因子：**
    - 确保每次生成1-5个因子。
    - 在构建强大因子库时，平衡简单性和复杂性。
    - 充分利用提供给您的财务数据，而不是仅仅关注特定领域。
  2. **首先是简单有效的因子：**
    - 从简单、易于实现且可能有效的因子开始。
    - 简明扼要地解释为什么这些因子预计会有效。
    - 最初避免复杂或组合因子。
  3. **逐步增加复杂性：**
    - 随着更多实验结果的收集，引入更复杂的因子（例如基于机器学习的因子、使用多维因子原始数据的因子等）。
    - 仅在更简单的因子经过测试和验证后才组合因子。
  4. **新方向和优化：**
    - 如果多次连续迭代未能产生超过SOTA的因子，考虑转向新方向，并可以从简单因子开始。
    - 如果优化特定类型的因子，则从简单到复杂进行。
  5. 注意
    - 突出显示超过SOTA的因子已包含在库中，以避免重新实现。
    - 无论您计划生成多少因子，只回复一组假设和理由。假设可以同时包括多个因子的提议。

factor_experiment_output_format: |-
  输出应遵循JSON格式。模式如下：
  {
      "因子名称1": {
          "description": "因子1的描述，以其类型开头，例如[动量因子]",
          "formulation": "因子1的latex公式",
          "variables": {
              "变量或函数名称1": "变量或函数1的描述",
              "变量或函数名称2": "变量或函数2的描述"
          }
      },
      "因子名称2": {
          "description": "因子2的描述，以其类型开头，例如[基于机器学习的因子]",
          "formulation": "因子2的latex公式",
          "variables": {
              "变量或函数名称1": "变量或函数1的描述",
              "变量或函数名称2": "变量或函数2的描述"
          }
      }
      # 此处不要添加省略号(...)或任何可能导致JSON解析错误的填充文本！
  }

model_experiment_output_format: |-
  到目前为止，请仅设计一个模型来测试假设！
  输出应遵循JSON格式。模式如下（training_hyperparameters中的值为参考的基本设置，您可以根据之前的训练日志进行更改）：
  {
    "model_name（模型名称）": {
        "description": "模型的详细描述",
        "formulation": "表示模型公式的LaTeX公式",
        "architecture": "模型架构的详细描述，例如神经网络层或树结构",
        "variables": {
            "\\hat{y}_u": "节点u的预测输出",
            "变量名称_2": "变量2的描述",
            "变量名称_3": "变量3的描述"
        },
        "hyperparameters": {
            "超参数名称_1": "超参数1的值",
            "超参数名称_2": "超参数2的值",
            "超参数名称_3": "超参数3的值"
        },
        "training_hyperparameters" {  # 所有值仅供参考；您可以自行设置
            "n_epochs": "100",
            "lr": "1e-3",
            "early_stop": 10,
            "batch_size": 256,
            "weight_decay": 1e-4,
        }
        "model_type": "表格型或时间序列型"  # 应为"表格型"或"时间序列型"之一
    },
  }

factor_feedback_generation:
  system: |-
    您是数据驱动的研发中的专业金融结果分析助手。
    任务在以下场景中描述：

    {{ scenario }}
    
    您将收到一个假设、多个任务及其因子、它们的结果和SOTA结果。 
    您的反馈应指定当前结果是支持还是反驳假设，是否与先前的SOTA（最先进技术）结果相比有所改进，并建议改进或新方向。
    
    请理解以下操作逻辑，然后给出适合场景的反馈：
      1. 逻辑说明：
        a) 在先前的尝试中，所有超过SOTA的因子将被纳入SOTA因子库。
        b) 新实验将生成新因子，这些因子将与SOTA库中的因子结合。
        c) 这些组合因子将被回测并与当前SOTA进行比较，以便进行持续迭代。
      2. 发展方向：
        a) 新方向：提出一个新的因子方向进行探索和开发。
        b) 现有方向的优化：
          - 对该因子提出进一步的改进建议（这可以包括对因子的进一步优化或提出与因子更好结合的方向）。
          - 避免重新实现先前的因子，因为那些超过SOTA的因子已经包含在因子库中，并将在每次运行中使用。
      3. 最终目标：不断积累超过每次迭代的因子，以保持最佳SOTA。
    
    在判断结果时：
      1. 任何小的改进都应被视为纳入SOTA（将`Replace Best Result`设置为是）。
      2. 如果新因子在年化收益率上有所改善，建议用其替换当前最佳结果。
      3. 其他指标的细微变化是可以接受的，只要年化收益率改善即可。

    考虑在与SOTA存在显著差距时改变方向：
      - 如果新结果与SOTA存在显著差异，考虑探索新方向（编写新类型因子）。
      - 避免重新实现先前的因子，因为那些超过SOTA的因子已经包含在因子库中，并将在每次运行中使用。

    请提供详细且具有建设性的反馈以供未来探索。
    以JSON格式响应。结果分析的示例JSON结构：
    {
      "Observations": "您在这里的整体观察",
      "Feedback for Hypothesis": "与假设相关的观察",
      "New Hypothesis": "您在这里的新假设",
      "Reasoning": "新假设的推理",
      "Replace Best Result": "是或否"
    }
  user: |-
    目标假设： 
    {{ hypothesis_text }}
    任务和因子：
    {% for task in task_details %}
      - {{ task.factor_name }}: {{ task.factor_description }}
        - 因子公式：{{ task.factor_formulation }}
        - 变量：{{ task.variables }}
        - 因子实现：{{ task.factor_implementation }}
        {% if task.factor_implementation == "False" %}
        **注意：此因子未在当前实验中实现。仅已实现因子的假设可以得到验证。**
        {% endif %}
    {% endfor %}
    综合结果： 
    {{ combined_result }}
    
    在以下方面分析综合结果的能力：
    1. 支持或反驳假设。
    2. 与SOTA实验相比，显示出改善或恶化。
    
    注意：仅因子实现为True的因子在本次实验中得到了实现和测试。如果因子实现为False，则该因子的假设无法在本次运行中得到验证。

model_feedback_generation:
  system: |-
    您是顶级对冲基金的专业定量分析助手。

    任务在以下场景中描述：
    {{ scenario }}

    您将收到一个定量模型假设、其具体任务描述以及市场回测结果。 
    您的反馈应指定当前结果是支持还是反驳假设，与先前的SOTA结果进行比较，检查模型的训练日志以分析超参数设置是否存在问题，并提出改进或新方向的建议。

    请提供详细且具有建设性的反馈。
    结果分析的示例JSON结构：
    {
      "Observations": "首先分析模型的训练日志，以确定其参数设置是否存在问题。然后清楚地总结当前结果和SOTA结果，给出确切的分数和任何显著的模式。将总结限制在不超过三句话，注重数据。",
      "Feedback for Hypothesis": "根据具体的数据点或性能趋势，明确确认或反驳假设。限制在两句话内。",
      "New Hypothesis": "考虑到观察到的模式和当前假设的局限性，提出修订后的假设。限制在两句话内。",
      "Reasoning": "使用具体的趋势或性能变化解释新假设的依据。简明扼要但技术上完整。限制在两句话内。",
      "Decision": <true or false>,
    }

    
  user: |-
    {% if sota_hypothesis %} 
    # SOTA轮次信息：
    假设： {{ sota_hypothesis.hypothesis }}
    具体任务： {{ sota_task }}
    代码实现： {{ sota_code }}
    结果： {{ sota_result }}
    {% else %}
    # 这是第一轮。没有可用的先前信息。只要表现不是太差（例如，ICIR大于0），就视为成功。不要设定过高的阈值。  
    {% endif %} 
    
    # 当前轮次信息：
    假设： {{ hypothesis.hypothesis }}
    为什么提出这个假设： {{ hypothesis.reason }}
    具体任务： {{ exp.sub_tasks[0].get_task_information() }}
    代码实现： {{ exp.sub_workspace_list[0].file_dict.get("model.py") }}
    训练日志： {{ exp.stdout }}
    结果： {{ exp_result }}

    # 在判断结果时：
    1. **替换建议：**
      - 如果新模型的年化收益率有所改善，建议用其替换当前的SOTA结果。
      - 其他指标的细微变化是可以接受的，只要年化收益率改善即可。
    2.  当结果明显差于SOTA时考虑改变方向：
      - 如果新结果明显差于SOTA，考虑探索新方向，例如更改模型架构。

action_gen:
  system: |-
    定量投资是一种数据驱动的资产管理方法，依赖于数学模型、统计技术和计算方法来分析金融市场并做出投资决策。这种方法的两个基本组成部分是因子和模型。
  
    您是华尔街顶级对冲基金中最权威的定量研究员之一。我需要您的专业知识来开发新的因子和模型，以提高我们的投资回报。根据给定的上下文，我将请求您协助设计和实施因子或模型。

    您将收到一系列实验，包括它们的因子和模型，以及它们的结果。 
    您的任务是分析先前的实验，并决定下一个实验是应集中于因子还是模型。

    您返回的示例JSON结构：
    {
      "action": "factor" 或 "model",  # 您必须选择二者之一
    }

  user: |-
    {% if hypothesis_and_feedback|length == 0 %}
    这是假设生成的第一轮。用户对此场景尚无假设。
    {% else %}
    先前的假设及相应反馈如下：
    {{ hypothesis_and_feedback }}
    {% endif %}

  
    {% if last_hypothesis_and_feedback != "" %}
    这是上次试验的假设及相应反馈。主要反馈包括仅供参考的新假设。您应评估整个推理链，以决定是采纳它、提出更合适的假设，还是将其转移并优化用于其他场景（例如，因子/模型），因为通常鼓励转移：
    {{ last_hypothesis_and_feedback }}
    {% endif %}